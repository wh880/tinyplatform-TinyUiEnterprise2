(function(c){var b=window.console||{log:function(){}};function a(d){this.$container=d;this.$avatarView=this.$container.find(".avatar-view");this.$avatar=this.$avatarView.find("img");this.$avatarModal=c("body").find("#avatar-modal");this.$loading=c("#page-wrapper").find(".loading");this.$avatarForm=this.$avatarModal.find(".avatar-form");this.$avatarUpload=this.$avatarForm.find(".avatar-upload");this.$avatarSrc=this.$avatarForm.find(".avatar-src");this.$avatarData=this.$avatarForm.find(".avatar-data");this.$avatarInput=this.$avatarForm.find(".avatar-input");this.$avatarSave=this.$avatarForm.find(".avatar-save");this.$avatarBtns=this.$avatarForm.find(".avatar-btns");this.$avatarWrapper=this.$avatarModal.find(".avatar-wrapper");this.$avatarPreview=this.$avatarModal.find(".avatar-preview");this.init()}a.prototype={constructor:a,support:{fileList:!!c('<input type="file">').prop("files"),blobURLs:!!window.URL&&URL.createObjectURL,formData:!!window.FormData},init:function(){this.support.datauri=this.support.fileList&&this.support.blobURLs;if(!this.support.formData){this.initIframe()}this.initTooltip();this.initModal();this.addListener()},addListener:function(){this.$avatarView.on("click",c.proxy(this.click,this));this.$avatarInput.on("change",c.proxy(this.change,this));this.$avatarForm.on("submit",c.proxy(this.submit,this));this.$avatarBtns.on("click",c.proxy(this.rotate,this))},initTooltip:function(){this.$avatarView.tooltip({placement:"bottom"})},initModal:function(){this.$avatarModal.modal({show:false})},initPreview:function(){var d=this.$avatar.attr("src");this.$avatarPreview.empty().html('<img src="'+d+'">')},initIframe:function(){var e="upload-iframe-"+(new Date()).getTime(),d=c("<iframe>").attr({name:e,src:""}),f=this;d.one("load",function(){d.on("load",function(){var g;try{g=c(this).contents().find("body").text()}catch(h){b.log(h.message)}if(g){try{g=c.parseJSON(g)}catch(h){b.log(h.message)}f.submitDone(g)}else{f.submitFail("Image upload failed!")}f.submitEnd()})});this.$iframe=d;this.$avatarForm.attr("target",e).after(d.hide())},click:function(){this.$avatarModal.modal("show");this.initPreview()},change:function(){var e,d;if(this.support.datauri){e=this.$avatarInput.prop("files");if(e.length>0){d=e[0];if(this.isImageFile(d)){if(this.url){URL.revokeObjectURL(this.url)}this.url=URL.createObjectURL(d);this.startCropper()}}}else{d=this.$avatarInput.val();if(this.isImageFile(d)){this.syncUpload()}}},submit:function(){if(!this.$avatarSrc.val()&&!this.$avatarInput.val()){return false}if(this.support.formData){this.ajaxUpload();return false}},rotate:function(f){var d;if(this.active){d=c(f.target).data();if(d.method){this.$img.cropper(d.method,d.option)}}},isImageFile:function(d){if(d.type){return/^image\/\w+$/.test(d.type)}else{return/\.(jpg|jpeg|png|gif)$/.test(d)}},startCropper:function(){var d=this;if(this.active){this.$img.cropper("replace",this.url)}else{this.$img=c('<img src="'+this.url+'">');this.$avatarWrapper.empty().html(this.$img);this.$img.cropper({aspectRatio:1,preview:this.$avatarPreview.selector,strict:false,crop:function(f){var e=['{"x":'+f.x,'"y":'+f.y,'"height":'+f.height,'"width":'+f.width,'"rotate":'+f.rotate+"}"].join();d.$avatarData.val(e)}});this.active=true}},stopCropper:function(){if(this.active){this.$img.cropper("destroy");this.$img.remove();this.active=false}},ajaxUpload:function(){var d=this.$avatarForm.attr("action"),e=new FormData(this.$avatarForm[0]),f=this;c.ajax(d,{headers:{"X-XSRF-TOKEN":c('meta[name="csrf-token"]').attr("content")},type:"post",data:e,dataType:"json",processData:false,contentType:false,beforeSend:function(){f.submitStart()},success:function(g){f.submitDone(g)},error:function(g,i,h){f.submitFail(i||h)},complete:function(){f.submitEnd()}})},syncUpload:function(){this.$avatarSave.click()},submitStart:function(){this.$loading.fadeIn()},submitDone:function(d){if(c.isPlainObject(d)){if(d.result){this.url=d.result;if(this.support.datauri||this.uploaded){this.uploaded=false;this.cropDone()}else{this.uploaded=true;this.$avatarSrc.val(this.url);this.startCropper()}this.$avatarInput.val("")}else{if(d.message){this.alert(d.message)}}}else{this.alert("Failed to response")}},submitFail:function(d){this.alert(d)},submitEnd:function(){this.$loading.fadeOut()},cropDone:function(){this.$avatarForm.get(0).reset();this.$avatar.attr("src",this.url);this.stopCropper();this.$avatarModal.modal("hide")},alert:function(e){var d=['<div class="alert alert-danger avater-alert">','<button type="button" class="close" data-dismiss="alert">&times;</button>',e,"</div>"].join("");this.$avatarUpload.after(d)}};c(function(){return new a(c("#crop-avatar"))})});