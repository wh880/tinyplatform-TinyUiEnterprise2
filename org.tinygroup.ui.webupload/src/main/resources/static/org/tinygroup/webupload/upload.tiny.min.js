(function(a){a(function(){var n=a(".uploader"),i=a('<ul class="filelist"></ul>').appendTo(n.find(".queueList")),t=n.find(".statusBar"),d=t.find(".info"),c=n.find(".uploadBtn"),g=n.find(".placeholder"),m=t.find(".progress").hide(),v=0,l=0,j=window.devicePixelRatio||1,k=110*j,b=110*j,h="pedding",w={},q=(function(){var z=new Image();var y=true;z.onload=z.onerror=function(){if(this.width!=1||this.height!=1){y=false}};z.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";return y})(),x=(function(){var y;try{y=navigator.plugins["Shockwave Flash"];y=y.description}catch(z){try{y=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(A){y="0.0"}}y=y.match(/\d+/g);return parseFloat(y[0]+"."+y[1],10)})(),s=(function(){var y=document.createElement("p").style,z="transition" in y||"WebkitTransition" in y||"MozTransition" in y||"msTransition" in y||"OTransition" in y;y=null;return z})(),p;if(!WebUploader.Uploader.support("flash")&&WebUploader.browser.ie){if(x){(function(y){window.expressinstallcallback=function(B){switch(B){case"Download.Cancelled":alert("您取消了更新！");break;case"Download.Failed":alert("安装失败");break;default:alert("安装已成功，请刷新！");break}delete window.expressinstallcallback};var A="./expressInstall.swf";var z='<object type="application/x-shockwave-flash" data="'+A+'" ';if(WebUploader.browser.ie){z+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}z+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+A+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';y.html(z)})(n)}else{n.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>')}return}else{if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！");return}}p=WebUploader.create({pick:{id:".filePicker",label:"点击选择图片"},formData:{uid:123},dnd:".dndArea",paste:".uploader",swf:"lib/Uploader.swf",chunked:false,chunkSize:512*1024,server:"fileupload.php",disableGlobalDnd:true,fileNumLimit:300,fileSizeLimit:200*1024*1024,fileSingleSizeLimit:50*1024*1024});p.on("dndAccept",function(A){var z=false,y=A.length,B=0,C="text/plain;application/javascript ";for(;B<y;B++){if(~C.indexOf(A[B].type)){z=true;break}}return !z});p.addButton({id:".filePicker2",label:"继续添加"});p.on("ready",function(){window.uploader=p});function r(D){var E=a('<li id="'+D.id+'"><p class="title">'+D.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),B=a('<div class="file-panel"><span class="cancel">删除</span><span class="rotateRight">向右旋转</span><span class="rotateLeft">向左旋转</span></div>').appendTo(E),A=E.find("p.progress span"),z=E.find("p.imgWrap"),C=a('<p class="error"></p>'),y=function(G,F){switch(G){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}if(F){text=F}C.text(text).appendTo(E)};if(D.getStatus()==="invalid"){y(D.statusText)}else{z.text("预览中");p.makeThumb(D,function(G,H){var F;if(G){z.text("不能预览");return}if(q){F=a('<img src="'+H+'">');z.empty().append(F)}},k,b);w[D.id]=[D.size,0];D.rotation=0}D.on("statuschange",function(G,F){if(F==="progress"){A.hide().width(0)}else{if(F==="queued"){E.off("mouseenter mouseleave");B.remove()}}if(G==="error"||G==="invalid"){y(D.statusText);w[D.id][1]=1}else{if(G==="interrupt"){y("interrupt")}else{if(G==="queued"){w[D.id][1]=0}else{if(G==="progress"){C.remove();A.css("display","block")}else{if(G==="complete"){E.append('<span class="success"></span>')}}}}}E.removeClass("state-"+F).addClass("state-"+G)});E.on("mouseenter",function(){B.stop().animate({height:30})});E.on("mouseleave",function(){B.stop().animate({height:0})});B.on("click","span",function(){var F=a(this).index(),G;switch(F){case 0:p.removeFile(D);return;case 1:D.rotation+=90;break;case 2:D.rotation-=90;break}if(s){G="rotate("+D.rotation+"deg)";z.css({"-webkit-transform":G,"-mos-transform":G,"-o-transform":G,transform:G})}else{z.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((D.rotation/90)%4+4)%4)+")")}});E.appendTo(i)}function u(y){var z=a("#"+y.id);delete w[y.id];e();z.off().find(".file-panel").off().end().remove()}function e(){var y=0,B=0,z=m.children(),A;a.each(w,function(D,C){B+=C[0];y+=C[0]*C[1]});A=B?y/B:0;z.eq(0).text(Math.round(A*100)+"%");z.eq(1).css("width",Math.round(A*100)+"%");f()}function f(){var z="",y;if(h==="ready"){z="选中"+v+"张图片，共"+WebUploader.formatSize(l)+"。"}else{if(h==="confirm"){y=p.getStats();if(y.uploadFailNum){z="已成功上传"+y.successNum+"张照片至XX相册，"+y.uploadFailNum+'张照片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'}}else{y=p.getStats();console.log(y);z="共"+v+"张（"+WebUploader.formatSize(l)+"），已上传"+y.successNum+"张";if(y.uploadFailNum){z+="，失败"+y.uploadFailNum+"张"}}}d.html(z)}function o(A){var z,y;if(A===h){return}c.removeClass("state-"+h);c.addClass("state-"+A);h=A;switch(h){case"pedding":g.removeClass("element-invisible");i.hide();t.addClass("element-invisible");p.refresh();break;case"ready":g.addClass("element-invisible");a(".filePicker2").removeClass("element-invisible");i.show();t.removeClass("element-invisible");p.refresh();break;case"uploading":a(".filePicker2").addClass("element-invisible");m.show();c.text("暂停上传");break;case"paused":m.show();c.text("继续上传");break;case"confirm":m.hide();a(".filePicker2").removeClass("element-invisible");c.text("开始上传");y=p.getStats();if(y.successNum&&!y.uploadFailNum){o("finish");return}break;case"finish":y=p.getStats();if(y.successNum){c.text("上传成功")}else{h="done";location.reload()}break}f()}p.onUploadProgress=function(A,y){var B=a("#"+A.id),z=B.find(".progress span");z.css("width",y*100+"%");w[A.id][1]=y;e()};p.onFileQueued=function(y){v++;l+=y.size;if(v===1){g.addClass("element-invisible");t.show()}r(y);o("ready");e()};p.onFileDequeued=function(y){v--;l-=y.size;if(!v){o("pedding")}u(y);e()};p.on("all",function(z){var y;switch(z){case"uploadFinished":o("confirm");break;case"startUpload":o("uploading");break;case"stopUpload":o("paused");break}});p.on("uploadAccept",function(z,y){if(y.error){alert(y.error.message);return false}});p.onError=function(y){alert("Eroor: "+y)};p.uploadError=function(y){alert("Eroor: "+y)};c.on("click",function(){if(a(this).hasClass("disabled")){return false}if(h==="ready"){p.upload()}else{if(h==="paused"){p.upload()}else{if(h==="uploading"){p.stop()}}}});d.on("click",".retry",function(){p.retry()});d.on("click",".ignore",function(){alert("todo")});c.addClass("state-"+h);e()})})(jQuery);