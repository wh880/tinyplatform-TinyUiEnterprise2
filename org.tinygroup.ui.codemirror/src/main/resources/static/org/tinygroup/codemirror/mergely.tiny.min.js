Mgly={};Mgly.Timer=function(){var a=this;a.start=function(){a.t0=new Date().getTime()};a.stop=function(){var b=new Date().getTime();var c=b-a.t0;a.t0=b;return c};a.start()};Mgly.ChangeExpression=new RegExp(/(\d+(?:,\d+)?)([acd])(\d+(?:,\d+)?)/);Mgly.DiffParser=function(j){var f=[];var k=0;var c=j.split(/\n/);for(var a=0;a<c.length;++a){if(c[a].length==0){continue}var e={};var d=Mgly.ChangeExpression.exec(c[a]);if(d==null){continue}var b=d[1].split(",");e["lhs-line-from"]=b[0]-1;if(b.length==1){e["lhs-line-to"]=b[0]-1}else{e["lhs-line-to"]=b[1]-1}var g=d[3].split(",");e["rhs-line-from"]=g[0]-1;if(g.length==1){e["rhs-line-to"]=g[0]-1}else{e["rhs-line-to"]=g[1]-1}e.op=d[2];f[k++]=e}return f};Mgly.sizeOf=function(c){var b=0,a;for(a in c){if(c.hasOwnProperty(a)){b++}}return b};Mgly.LCS=function(a,b){this.x=a.replace(/[ ]{1}/g,"\n");this.y=b.replace(/[ ]{1}/g,"\n")};jQuery.extend(Mgly.LCS.prototype,{clear:function(){this.ready=0},diff:function(j,e){var f=new Mgly.diff(this.x,this.y,{ignorews:false});var k=Mgly.DiffParser(f.normal_form());var m=0,l=0;for(var b=0;b<k.length;++b){var g=k[b];if(g.op!="a"){m=f.getLines("lhs").slice(0,g["lhs-line-from"]).join(" ").length;l=g["lhs-line-to"]+1;var a=f.getLines("lhs").slice(g["lhs-line-from"],l).join(" ");if(g.op=="d"){a+=" "}else{if(m>0&&g.op=="c"){m+=1}}e(m,m+a.length)}if(g.op!="d"){m=f.getLines("rhs").slice(0,g["rhs-line-from"]).join(" ").length;l=g["rhs-line-to"]+1;var c=f.getLines("rhs").slice(g["rhs-line-from"],l).join(" ");if(g.op=="a"){c+=" "}else{if(m>0&&g.op=="c"){m+=1}}j(m,m+c.length)}}}});Mgly.CodeifyText=function(a){this._max_code=0;this._diff_codes={};this.ctxs={};this.options={ignorews:false};jQuery.extend(this,a);this.lhs=a.lhs.split("\n");this.rhs=a.rhs.split("\n")};jQuery.extend(Mgly.CodeifyText.prototype,{getCodes:function(b){if(!this.ctxs.hasOwnProperty(b)){var a=this._diff_ctx(this[b]);this.ctxs[b]=a;a.codes.length=Object.keys(a.codes).length}return this.ctxs[b].codes},getLines:function(a){return this.ctxs[a].lines},_diff_ctx:function(b){var a={i:0,codes:{},lines:b};this._codeify(b,a);return a},_codeify:function(c,b){var f=this._max_code;for(var e=0;e<c.length;++e){var a=c[e];if(this.options.ignorews){a=a.replace(/\s+/g,"")}var d=this._diff_codes[a];if(d!=undefined){b.codes[e]=d}else{this._max_code++;this._diff_codes[a]=this._max_code;b.codes[e]=this._max_code}}}});Mgly.diff=function(c,e,j){var a=jQuery.extend({ignorews:false},j);this.codeify=new Mgly.CodeifyText({lhs:c,rhs:e,options:a});var g={codes:this.codeify.getCodes("lhs"),modified:{}};var i={codes:this.codeify.getCodes("rhs"),modified:{}};var f=(g.codes.length+i.codes.length+1);var b=Array(2*f+2);var d=Array(2*f+2);this._lcs(g,0,g.codes.length,i,0,i.codes.length,d,b);this._optimize(g);this._optimize(i);this.items=this._create_diffs(g,i)};jQuery.extend(Mgly.diff.prototype,{changes:function(){return this.items},getLines:function(a){return this.codeify.getLines(a)},normal_form:function(){var b="";for(var e=0;e<this.items.length;++e){var k=this.items[e];var d="";var g="";var j="c";if(k.lhs_deleted_count==0&&k.rhs_inserted_count>0){j="a"}else{if(k.lhs_deleted_count>0&&k.rhs_inserted_count==0){j="d"}}if(k.lhs_deleted_count==1){d=k.lhs_start+1}else{if(k.lhs_deleted_count==0){d=k.lhs_start}else{d=(k.lhs_start+1)+","+(k.lhs_start+k.lhs_deleted_count)}}if(k.rhs_inserted_count==1){g=k.rhs_start+1}else{if(k.rhs_inserted_count==0){g=k.rhs_start}else{g=(k.rhs_start+1)+","+(k.rhs_start+k.rhs_inserted_count)}}b+=d+j+g+"\n";var f=this.getLines("lhs");var a=this.getLines("rhs");if(a&&f){for(var c=k.lhs_start;c<k.lhs_start+k.lhs_deleted_count;++c){b+="< "+f[c]+"\n"}if(k.rhs_inserted_count&&k.lhs_deleted_count){b+="---\n"}for(var c=k.rhs_start;c<k.rhs_start+k.rhs_inserted_count;++c){b+="> "+a[c]+"\n"}}}return b},_lcs:function(i,a,e,j,g,c,f,d){while((a<e)&&(g<c)&&(i.codes[a]==j.codes[g])){++a;++g}while((a<e)&&(g<c)&&(i.codes[e-1]==j.codes[c-1])){--e;--c}if(a==e){while(g<c){j.modified[g++]=true}}else{if(g==c){while(a<e){i.modified[a++]=true}}else{var b=this._sms(i,a,e,j,g,c,f,d);this._lcs(i,a,b.x,j,g,b.y,f,d);this._lcs(i,b.x,e,j,b.y,c,f,d)}}},_sms:function(a,l,e,o,u,p,b,f){var r=a.codes.length+o.codes.length+1;var j=l-u;var n=e-p;var v=(e-l)-(p-u);var c=(v&1)!=0;var s=r-j;var w=r-n;var m=((e-l+p-u)/2)+1;f[s+j+1]=l;b[w+n-1]=e;var z={x:0,y:0};for(var t=0;t<=m;++t){for(var q=j-t;q<=j+t;q+=2){var i,g;if(q==j-t){i=f[s+q+1]}else{i=f[s+q-1]+1;if((q<(j+t))&&(f[s+q+1]>=i)){i=f[s+q+1]}}g=i-q;while((i<e)&&(g<p)&&(a.codes[i]==o.codes[g])){i++;g++}f[s+q]=i;if(c&&(n-t<q)&&(q<n+t)){if(b[w+q]<=f[s+q]){z.x=f[s+q];z.y=f[s+q]-q;return(z)}}}for(var q=n-t;q<=n+t;q+=2){var i,g;if(q==n+t){i=b[w+q-1]}else{i=b[w+q+1]-1;if((q>n-t)&&(b[w+q-1]<i)){i=b[w+q-1]}}g=i-q;while((i>l)&&(g>u)&&(a.codes[i-1]==o.codes[g-1])){i--;g--}b[w+q]=i;if(!c&&(j-t<=q)&&(q<=j+t)){if(b[w+q]<=f[s+q]){z.x=f[s+q];z.y=f[s+q]-q;return(z)}}}}throw"the algorithm should never come here."},_optimize:function(b){var c=0,a=0;while(c<b.length){while((c<b.length)&&(b.modified[c]==undefined||b.modified[c]==false)){c++}a=c;while((a<b.length)&&(b.modified[a]==true)){a++}if((a<b.length)&&(b.ctx[c]==b.codes[a])){b.modified[c]=false;b.modified[a]=true}else{c=a}}},_create_diffs:function(c,g){var a=[];var f=0,b=0;var e=0,d=0;while(e<c.codes.length||d<g.codes.length){if((e<c.codes.length)&&(!c.modified[e])&&(d<g.codes.length)&&(!g.modified[d])){e++;d++}else{f=e;b=d;while(e<c.codes.length&&(d>=g.codes.length||c.modified[e])){e++}while(d<g.codes.length&&(e>=c.codes.length||g.modified[d])){d++}if((f<e)||(b<d)){a.push({lhs_start:f,rhs_start:b,lhs_deleted_count:e-f,rhs_inserted_count:d-b})}}}return a}});Mgly.mergely=function(b,a){if(b){this.init(b,a)}};jQuery.extend(Mgly.mergely.prototype,{name:"mergely",init:function(b,a){this.diffView=new Mgly.CodeMirrorDiffView(b,a);this.bind(b)},bind:function(a){this.diffView.bind(a)}});Mgly.CodeMirrorDiffView=function(b,a){CodeMirror.defineExtension("centerOnCursor",function(){var c=this.cursorCoords(null,"local");this.scrollTo(null,(c.y+c.yBot)/2-(this.getScrollerElement().clientHeight/2))});this.init(b,a)};jQuery.extend(Mgly.CodeMirrorDiffView.prototype,{init:function(c,b){this.settings={autoupdate:true,autoresize:true,rhs_margin:"right",lcs:true,sidebar:true,viewport:false,ignorews:false,fadein:"fast",editor_width:"400px",editor_height:"400px",resize_timeout:500,change_timeout:150,fgcolor:{a:"#4ba3fa",c:"#a3a3a3",d:"#ff7f7f"},bgcolor:"#eee",vpcolor:"rgba(0, 0, 200, 0.5)",lhs:function(d){},rhs:function(d){},loaded:function(){},_auto_width:function(d){return d},resize:function(i){var j=i?16:0;var e=jQuery(c).parent().width()+j;if(this.width=="auto"){e=this._auto_width(e)}else{e=this.width;this.editor_width=e}if(this.height=="auto"){h=jQuery(c).parent().height()}else{h=this.height;this.editor_height=h}var g=e/2-2*8-8;var d=h;var f=jQuery(c);f.find(".mergely-column").css({width:g+"px"});f.find(".mergely-column, .mergely-canvas, .mergely-margin, .mergely-column textarea, .CodeMirror-scroll, .cm-s-default").css({height:d+"px"});f.find(".mergely-canvas").css({height:d+"px"});f.find(".mergely-column textarea").css({width:g+"px"});f.css({width:e,height:h,clear:"both"});if(f.css("display")=="none"){if(this.fadein!=false){f.fadeIn(this.fadein)}else{f.show()}if(this.loaded){this.loaded()}}if(this.resized){this.resized()}},_debug:"",resized:function(){}};var a={mode:"text/plain",readOnly:false,lineWrapping:false,lineNumbers:true,gutters:["merge","CodeMirror-linenumbers"]};this.lhs_cmsettings={};this.rhs_cmsettings={};this.element=jQuery(c);if(b&&b.cmsettings){jQuery.extend(this.lhs_cmsettings,a,b.cmsettings,b.lhs_cmsettings)}if(b&&b.cmsettings){jQuery.extend(this.rhs_cmsettings,a,b.cmsettings,b.rhs_cmsettings)}if(b){jQuery.extend(this.settings,b)}this.element.bind("destroyed",jQuery.proxy(this.teardown,this));jQuery.data(c,"mergely",this)},unbind:function(){if(this.changed_timeout!=null){clearTimeout(this.changed_timeout)}this.editor[this.id+"-lhs"].toTextArea();this.editor[this.id+"-rhs"].toTextArea()},destroy:function(){this.element.unbind("destroyed",this.teardown);this.teardown()},teardown:function(){this.unbind()},lhs:function(a){this.editor[this.id+"-lhs"].setValue(a)},rhs:function(a){this.editor[this.id+"-rhs"].setValue(a)},update:function(){this._changing(this.id+"-lhs",this.id+"-rhs")},unmarkup:function(){this._clear()},scrollTo:function(c,a){var b=this.editor[this.id+"-lhs"];var d=this.editor[this.id+"-rhs"];if(c=="lhs"){b.setCursor(a);b.centerOnCursor()}else{d.setCursor(a);d.centerOnCursor()}},options:function(a){if(a){jQuery.extend(this.settings,a);if(this.settings.autoresize){this.resize()}if(this.settings.autoupdate){this.update()}if(this.settings.hasOwnProperty("rhs_margin")){if(this.settings.rhs_margin=="left"){this.element.find(".mergely-margin:last-child").insertAfter(this.element.find(".mergely-canvas"))}else{var b=this.element.find(".mergely-margin").last();b.appendTo(b.parent())}}if(this.settings.hasOwnProperty("sidebar")){if(this.settings.sidebar){jQuery(this.element).find(".mergely-margin").css({display:"block"})}else{jQuery(this.element).find(".mergely-margin").css({display:"none"})}}}else{return this.settings}},swap:function(){if(this.lhs_cmsettings.readOnly||this.rhs_cmsettings.readOnly){return}var b=this.editor[this.id+"-lhs"];var c=this.editor[this.id+"-rhs"];var a=c.getValue();c.setValue(b.getValue());b.setValue(a)},merge:function(b){var a=this.editor[this.id+"-lhs"];var c=this.editor[this.id+"-rhs"];if(b=="lhs"&&!this.lhs_cmsettings.readOnly){a.setValue(c.getValue())}else{if(!this.rhs_cmsettings.readOnly){c.setValue(a.getValue())}}},get:function(c){var a=this.editor[this.id+"-"+c];var b=a.getValue();if(b==undefined){return""}return b},clear:function(b){if(b=="lhs"&&this.lhs_cmsettings.readOnly){return}if(b=="rhs"&&this.rhs_cmsettings.readOnly){return}var a=this.editor[this.id+"-"+b];a.setValue("")},cm:function(a){return this.editor[this.id+"-"+a]},search:function(b,e,f){var a=this.editor[this.id+"-lhs"];var d=this.editor[this.id+"-rhs"];var c;if(b=="lhs"){c=a}else{c=d}f=(f=="prev")?"findPrevious":"findNext";if((c.getSelection().length==0)||(this.prev_query[b]!=e)){this.cursor[this.id]=c.getSearchCursor(e,{line:0,ch:0},false);this.prev_query[b]=e}var g=this.cursor[this.id];if(g[f]()){c.setSelection(g.from(),g.to())}else{g=c.getSearchCursor(e,{line:0,ch:0},false)}},resize:function(){this.settings.resize();this._changing(this.id+"-lhs",this.id+"-rhs");this._set_top_offset(this.id+"-lhs")},diff:function(){var a=this.editor[this.id+"-lhs"].getValue();var c=this.editor[this.id+"-rhs"].getValue();var b=new Mgly.diff(a,c,this.settings);return b.normal_form()},bind:function(d){jQuery(this.element).hide();this.id=jQuery(d).attr("id");var m=this.settings.editor_height;var b=this.settings.editor_width;this.changed_timeout=null;this.chfns={};this.chfns[this.id+"-lhs"]=[];this.chfns[this.id+"-rhs"]=[];this.prev_query=[];this.cursor=[];this._skipscroll={};this.change_exp=new RegExp(/(\d+(?:,\d+)?)([acd])(\d+(?:,\d+)?)/);var i;var o;if(jQuery.button!=undefined){i='<button title="Merge left"></button>';o='<button title="Merge right"></button>'}else{var a="opacity:0.4;width:10px;height:15px;background-color:#888;cursor:pointer;text-align:center;color:#eee;border:1px solid: #222;margin-right:5px;";i='<div style="'+a+'" title="Merge left">&lt;</div>';o='<div style="'+a+'" title="Merge right">&gt;</div>'}this.merge_rhs_button=jQuery(o);this.merge_lhs_button=jQuery(i);jQuery(this.element).append(jQuery('<div class="mergely-margin" style="height: '+m+'"><canvas id="'+this.id+'-lhs-margin" width="8px" height="'+m+'"></canvas></div>'));jQuery(this.element).append(jQuery('<div style="position:relative;width:'+b+"; height:"+m+'" id="'+this.id+'-editor-lhs" class="mergely-column"><textarea style="" id="'+this.id+'-lhs"></textarea></div>'));jQuery(this.element).append(jQuery('<div class="mergely-canvas" style="height: '+m+'"><canvas id="'+this.id+"-lhs-"+this.id+'-rhs-canvas" style="width:28px" width="28px" height="'+m+'"></canvas></div>'));var c=jQuery('<div class="mergely-margin" style="height: '+m+'"><canvas id="'+this.id+'-rhs-margin" width="8px" height="'+m+'"></canvas></div>');if(!this.settings.sidebar){jQuery(this.element).find(".mergely-margin").css({display:"none"})}if(this.settings.rhs_margin=="left"){jQuery(this.element).append(c)}jQuery(this.element).append(jQuery('<div style="width:'+b+"; height:"+m+'" id="'+this.id+'-editor-rhs" class="mergely-column"><textarea style="" id="'+this.id+'-rhs"></textarea></div>'));if(this.settings.rhs_margin!="left"){jQuery(this.element).append(c)}var e="#"+this.id+" .CodeMirror-gutter-text { padding: 5px 0 0 0; }#"+this.id+" .CodeMirror-lines pre, #"+this.id+" .CodeMirror-gutter-text pre { line-height: 18px; }.CodeMirror-linewidget { overflow: hidden; };";if(this.settings.autoresize){e+=this.id+" .CodeMirror-scroll { height: 100%; overflow: auto; }"}jQuery('<style type="text/css">'+e+"</style>").appendTo("head");var f=jQuery("#"+this.id+"-rhs").get(0);if(!f){console.error("rhs textarea not defined - Mergely not initialized properly");return}var l=jQuery("#"+this.id+"-lhs").get(0);if(!f){console.error("lhs textarea not defined - Mergely not initialized properly");return}var n=this;this.editor=[];this.editor[this.id+"-lhs"]=CodeMirror.fromTextArea(l,this.lhs_cmsettings);this.editor[this.id+"-rhs"]=CodeMirror.fromTextArea(f,this.rhs_cmsettings);this.editor[this.id+"-lhs"].on("change",function(){if(n.settings.autoupdate){n._changing(n.id+"-lhs",n.id+"-rhs")}});this.editor[this.id+"-lhs"].on("scroll",function(){n._scrolling(n.id+"-lhs")});this.editor[this.id+"-rhs"].on("change",function(){if(n.settings.autoupdate){n._changing(n.id+"-lhs",n.id+"-rhs")}});this.editor[this.id+"-rhs"].on("scroll",function(){n._scrolling(n.id+"-rhs")});if(this.settings.autoresize){var k=null;var j=function(p){if(n.settings.resize){n.settings.resize(p)}n.editor[n.id+"-lhs"].refresh();n.editor[n.id+"-rhs"].refresh();if(n.settings.autoupdate){n._changing(n.id+"-lhs",n.id+"-rhs")}};jQuery(window).resize(function(){if(k){clearTimeout(k)}k=setTimeout(j,n.settings.resize_timeout)});j(true)}if(this.settings.lhs){var g=this.editor[this.id+"-lhs"].getDoc().setValue;this.settings.lhs(g.bind(this.editor[this.id+"-lhs"].getDoc()))}if(this.settings.rhs){var g=this.editor[this.id+"-rhs"].getDoc().setValue;this.settings.rhs(g.bind(this.editor[this.id+"-rhs"].getDoc()))}},_scrolling:function(e){if(this._skipscroll[e]===true){this._skipscroll[e]=false;return}var p=jQuery(this.editor[e].getScrollerElement());if(this.midway==undefined){this.midway=(p.height()/2+p.offset().top).toFixed(2)}var k=this.editor[e].coordsChar({left:0,top:this.midway});var d=p.scrollTop();var l=p.scrollLeft();this.trace("scroll","side",e);this.trace("scroll","midway",this.midway);this.trace("scroll","midline",k);this.trace("scroll","top_to",d);this.trace("scroll","left_to",l);var b=this.id+"-lhs";var t=this.id+"-rhs";for(var s in this.editor){if(!this.editor.hasOwnProperty(s)){continue}if(e==s){continue}var o=e.replace(this.id+"-","");var f=s.replace(this.id+"-","");var q=0;var a=null;var r=false;for(var m=0;m<this.changes.length;++m){var j=this.changes[m];if((k.line>=j[o+"-line-from"])){a=j;if(k.line>=a[o+"-line-to"]){if(!j.hasOwnProperty(o+"-y-start")||!j.hasOwnProperty(o+"-y-end")||!j.hasOwnProperty(f+"-y-start")||!j.hasOwnProperty(f+"-y-end")){r=true}else{q+=(j[o+"-y-end"]-j[o+"-y-start"])-(j[f+"-y-end"]-j[f+"-y-start"])}}}}var n=this.editor[s].getViewport();var c=true;if(a){this.trace("scroll","last change before midline",a);if(k.line>=n.from&&k<=n.to){c=false}}this.trace("scroll","scroll",c);if(c||r){this.trace("scroll","scrolling other side",d-q);var p=jQuery(this.editor[s].getScrollerElement());this._skipscroll[s]=true;p.scrollTop(d-q).scrollLeft(l)}else{this.trace("scroll","not scrolling other side")}if(this.settings.autoupdate){var g=new Mgly.Timer();this._calculate_offsets(b,t,this.changes);this.trace("change","offsets time",g.stop());this._markup_changes(b,t,this.changes);this.trace("change","markup time",g.stop());this._draw_diff(b,t,this.changes);this.trace("change","draw time",g.stop())}this.trace("scroll","scrolled")}},_changing:function(c,b){this.trace("change","changing-timeout",this.changed_timeout);var a=this;if(this.changed_timeout!=null){clearTimeout(this.changed_timeout)}this.changed_timeout=setTimeout(function(){var d=new Mgly.Timer();a._changed(c,b);a.trace("change","total time",d.stop())},this.settings.change_timeout)},_changed:function(b,a){this._clear();this._diff(b,a)},_clear:function(){var b=this;for(var c in this.editor){if(!this.editor.hasOwnProperty(c)){continue}var f=this.editor[c];var e=b.chfns[c];f.operation(function(){var n=new Mgly.Timer();for(var k=0,j=f.lineCount();k<j;++k){f.removeLineClass(k,"background")}for(var k=0;k<e.length;++k){var m=e[k];if(m.lines.length){b.trace("change","clear text",m.lines[0].text)}m.clear()}f.clearGutter("merge");b.trace("change","clear time",n.stop())})}b.chfns[c]=[];var d=this._draw_info(this.id+"-lhs",this.id+"-rhs");var i=d.clhs.get(0).getContext("2d");var g=d.crhs.get(0).getContext("2d");var a=d.dcanvas.getContext("2d");i.beginPath();i.fillStyle=this.settings.bgcolor;i.strokeStyle="#888";i.fillRect(0,0,6.5,d.visible_page_height);i.strokeRect(0,0,6.5,d.visible_page_height);g.beginPath();g.fillStyle=this.settings.bgcolor;g.strokeStyle="#888";g.fillRect(0,0,6.5,d.visible_page_height);g.strokeRect(0,0,6.5,d.visible_page_height);a.beginPath();a.fillStyle="#fff";a.fillRect(0,0,this.draw_mid_width,d.visible_page_height)},_diff:function(c,b){var a=this.editor[c].getValue();var g=this.editor[b].getValue();var f=new Mgly.Timer();var e=new Mgly.diff(a,g,this.settings);this.trace("change","diff time",f.stop());this.changes=Mgly.DiffParser(e.normal_form());this.trace("change","parse time",f.stop());this._calculate_offsets(c,b,this.changes);this.trace("change","offsets time",f.stop());this._markup_changes(c,b,this.changes);this.trace("change","markup time",f.stop());this._draw_diff(c,b,this.changes);this.trace("change","draw time",f.stop())},_parse_diff:function(b,a,l){this.trace("diff","diff results:\n",l);var j=[];var m=0;var e=l.split(/\n/);for(var c=0;c<e.length;++c){if(e[c].length==0){continue}var g={};var f=this.change_exp.exec(e[c]);if(f==null){continue}var d=f[1].split(",");g["lhs-line-from"]=d[0]-1;if(d.length==1){g["lhs-line-to"]=d[0]-1}else{g["lhs-line-to"]=d[1]-1}var k=f[3].split(",");g["rhs-line-from"]=k[0]-1;if(k.length==1){g["rhs-line-to"]=k[0]-1}else{g["rhs-line-to"]=k[1]-1}if(g["lhs-line-from"]<0){g["lhs-line-from"]=0}if(g["lhs-line-to"]<0){g["lhs-line-to"]=0}if(g["rhs-line-from"]<0){g["rhs-line-from"]=0}if(g["rhs-line-to"]<0){g["rhs-line-to"]=0}g.op=f[2];j[m++]=g;this.trace("diff","change",g)}return j},_get_viewport:function(c,b){var d=this.editor[c].getViewport();var a=this.editor[b].getViewport();return{from:Math.min(d.from,a.from),to:Math.max(d.to,a.to)}},_is_change_in_view:function(a,b){if(!this.settings.viewport){return true}if((b["lhs-line-from"]<a.from&&b["lhs-line-to"]<a.to)||(b["lhs-line-from"]>a.from&&b["lhs-line-to"]>a.to)||(b["rhs-line-from"]<a.from&&b["rhs-line-to"]<a.to)||(b["rhs-line-from"]>a.from&&b["rhs-line-to"]>a.to)){return false}return true},_set_top_offset:function(b){var d=this.editor[b].getScrollInfo().top;this.editor[b].scrollTo(null,0);var c=jQuery("#"+this.id+" .CodeMirror-measure").first();var a=c.offset().top-4;if(!a){return false}this.editor[b].scrollTo(null,d);this.draw_top_offset=0.5-a;return true},_calculate_offsets:function(a,z,y){if(this.em_height==null){if(!this._set_top_offset(a)){return}this.em_height=this.editor[a].defaultTextHeight();if(!this.em_height){console.warn("Failed to calculate offsets, using 18 by default");this.em_height=18}this.draw_lhs_min=0.5;var w=jQuery("#"+a+"-"+z+"-canvas");if(!w.length){console.error("failed to find canvas","#"+a+"-"+z+"-canvas")}if(!w.width()){console.error("canvas width is 0");return}this.draw_mid_width=jQuery("#"+a+"-"+z+"-canvas").width();this.draw_rhs_max=this.draw_mid_width-0.5;this.draw_lhs_width=5;this.draw_rhs_width=5;this.trace("calc","change offsets calculated",{top_offset:this.draw_top_offset,lhs_min:this.draw_lhs_min,rhs_max:this.draw_rhs_max,lhs_width:this.draw_lhs_width,rhs_width:this.draw_rhs_width})}var n=this.editor[a].charCoords({line:0});var f=this.editor[z].charCoords({line:0});var v=this._get_viewport(a,z);for(var t=0;t<y.length;++t){var l=y[t];if(!this.settings.sidebar&&!this._is_change_in_view(v,l)){delete l["lhs-y-start"];delete l["lhs-y-end"];delete l["rhs-y-start"];delete l["rhs-y-end"];continue}var e=l["lhs-line-from"]>=0?l["lhs-line-from"]:0;var b=l["lhs-line-to"]>=0?l["lhs-line-to"]:0;var r=l["rhs-line-from"]>=0?l["rhs-line-from"]:0;var j=l["rhs-line-to"]>=0?l["rhs-line-to"]:0;var d,p,g,q;if(this.editor[a].getOption("lineWrapping")||this.editor[a].getOption("lineWrapping")){var m=this.editor[a].cursorCoords({line:e,ch:0},"page");var s=this.editor[a].getLineHandle(e);d={top:m.top,bottom:m.top+s.height};var u=this.editor[a].cursorCoords({line:b,ch:0},"page");var x=this.editor[a].getLineHandle(b);p={top:u.top,bottom:u.top+x.height};var m=this.editor[z].cursorCoords({line:r,ch:0},"page");var k=this.editor[z].getLineHandle(r);g={top:m.top,bottom:m.top+k.height};var u=this.editor[z].cursorCoords({line:j,ch:0},"page");var o=this.editor[z].getLineHandle(j);q={top:u.top,bottom:u.top+o.height}}else{d={top:n.top+e*this.em_height,bottom:n.bottom+e*this.em_height+2};p={top:n.top+b*this.em_height,bottom:n.bottom+b*this.em_height+2};g={top:f.top+r*this.em_height,bottom:f.bottom+r*this.em_height+2};q={top:f.top+j*this.em_height,bottom:f.bottom+j*this.em_height+2}}if(l.op=="a"){if(r>0){d.top=d.bottom;d.bottom+=this.em_height;p=d}}else{if(l.op=="d"){if(e>0){g.top=g.bottom;g.bottom+=this.em_height;q=g}}}l["lhs-y-start"]=this.draw_top_offset+d.top;if(l.op=="c"||l.op=="d"){l["lhs-y-end"]=this.draw_top_offset+p.bottom}else{l["lhs-y-end"]=this.draw_top_offset+p.top}l["rhs-y-start"]=this.draw_top_offset+g.top;if(l.op=="c"||l.op=="a"){l["rhs-y-end"]=this.draw_top_offset+q.bottom}else{l["rhs-y-end"]=this.draw_top_offset+q.top}this.trace("calc","change calculated",t,l)}return y},_markup_changes:function(a,H,E){jQuery(".merge-button").remove();var s=this;var G=this.editor[a];var l=this.editor[H];var r=new Mgly.Timer();G.operation(function(){for(var J=0;J<E.length;++J){var M=E[J];var K=M["lhs-line-from"]>=0?M["lhs-line-from"]:0;var O=M["lhs-line-to"]>=0?M["lhs-line-to"]:0;var N=M["rhs-line-from"]>=0?M["rhs-line-from"]:0;var p=M["rhs-line-to"]>=0?M["rhs-line-to"]:0;var L=["mergely","lhs",M.op,"cid-"+J];G.addLineClass(K,"background","start");G.addLineClass(O,"background","end");if(K==0&&O==0&&N==0){G.addLineClass(K,"background",L.join(" "));G.addLineClass(K,"background","first")}else{for(var I=K;I<=O;++I){G.addLineClass(I,"background",L.join(" "));G.addLineClass(I,"background",L.join(" "))}}if(!l.getOption("readOnly")){var k=s.merge_rhs_button.clone();if(k.button){k.button({icons:{primary:"ui-icon-triangle-1-e"},text:false})}k.addClass("merge-button");k.attr("id","merge-rhs-"+J);G.setGutterMarker(K,"merge",k.get(0))}}});var C=this._get_viewport(a,H);this.trace("change","markup lhs-editor time",r.stop());l.operation(function(){for(var I=0;I<E.length;++I){var M=E[I];var J=M["lhs-line-from"]>=0?M["lhs-line-from"]:0;var O=M["lhs-line-to"]>=0?M["lhs-line-to"]:0;var N=M["rhs-line-from"]>=0?M["rhs-line-from"]:0;var k=M["rhs-line-to"]>=0?M["rhs-line-to"]:0;if(!s._is_change_in_view(C,M)){continue}var K=["mergely","rhs",M.op,"cid-"+I];l.addLineClass(N,"background","start");l.addLineClass(k,"background","end");if(N==0&&k==0&&J==0){l.addLineClass(N,"background",K.join(" "));l.addLineClass(N,"background","first")}else{for(var p=N;p<=k;++p){l.addLineClass(p,"background",K.join(" "));l.addLineClass(p,"background",K.join(" "))}}if(!G.getOption("readOnly")){var L=s.merge_lhs_button.clone();if(L.button){L.button({icons:{primary:"ui-icon-triangle-1-w"},text:false})}L.addClass("merge-button");L.attr("id","merge-lhs-"+I);l.setGutterMarker(N,"merge",L.get(0))}}});this.trace("change","markup rhs-editor time",r.stop());var w=[];for(var B=0;this.settings.lcs&&B<E.length;++B){var q=E[B];var m=q["lhs-line-from"]>=0?q["lhs-line-from"]:0;var b=q["lhs-line-to"]>=0?q["lhs-line-to"]:0;var v=q["rhs-line-from"]>=0?q["rhs-line-from"]:0;var n=q["rhs-line-to"]>=0?q["rhs-line-to"]:0;if(!this._is_change_in_view(C,q)){continue}if(q.op=="d"){var y=m;var d=b;var c=G.lineInfo(d);if(c){w.push([G,{line:y,ch:0},{line:d,ch:c.text.length},{className:"mergely ch d lhs"}])}}else{if(q.op=="c"){for(var z=m,x=v,t=0;((z>=0)&&(z<=b))||((x>=0)&&(x<=n));++z,++x){if(x+t>n){var D=G.getLine(z);w.push([G,{line:z,ch:0},{line:z,ch:D.length},{className:"mergely ch d lhs"}]);continue}if(z+t>b){var o=l.getLine(x);w.push([l,{line:x,ch:0},{line:x,ch:o.length},{className:"mergely ch a rhs"}]);continue}var D=G.getLine(z);var o=l.getLine(x);var A={line:-1,ch:-1};var f={line:-1,ch:-1};var e={line:-1,ch:-1};var u={line:-1,ch:-1};var F=new Mgly.LCS(D,o);F.diff(function(j,i){w.push([l,{line:x,ch:j},{line:x,ch:i},{className:"mergely ch a rhs"}])},removed=function(j,i){w.push([G,{line:z,ch:j},{line:z,ch:i},{className:"mergely ch d lhs"}])})}}}}this.trace("change","LCS marktext time",r.stop());G.operation(function(){for(var k=0;k<w.length;++k){var j=w[k];if(j[0].doc.id!=G.getDoc().id){continue}s.chfns[s.id+"-lhs"].push(j[0].markText(j[1],j[2],j[3]))}});l.operation(function(){for(var k=0;k<w.length;++k){var j=w[k];if(j[0].doc.id!=l.getDoc().id){continue}s.chfns[s.id+"-rhs"].push(j[0].markText(j[1],j[2],j[3]))}});this.trace("change","LCS markup time",r.stop());var g={lhs:G,rhs:l};jQuery(".merge-button").on("click",function(L){var I="rhs";var R="lhs";var O=jQuery(this).parents("#"+s.id+"-editor-lhs");if(O.length){I="lhs";R="rhs"}var J=g[I].coordsChar({left:L.pageX,top:L.pageY});var p=null;var j=g[I].lineInfo(J.line);jQuery.each(j.bgClass.split(" "),function(T,S){if(S.indexOf("cid-")==0){p=parseInt(S.split("-")[1],10);return false}});var K=s.changes[p];var Q={lhs:g.lhs.lineInfo(b),rhs:g.rhs.lineInfo(n)};var P=g[I].getRange(CodeMirror.Pos(K[I+"-line-from"],0),CodeMirror.Pos(K[I+"-line-to"]+1,0));if(K.op=="c"){g[R].replaceRange(P,CodeMirror.Pos(K[R+"-line-from"],0),CodeMirror.Pos(K[R+"-line-to"]+1,0))}else{if(I=="rhs"){if(K.op=="a"){g[R].replaceRange(P,CodeMirror.Pos(K[R+"-line-from"]+1,0),CodeMirror.Pos(K[R+"-line-to"]+1,0))}else{var N=parseInt(K[R+"-line-from"]);var M=parseInt(K[R+"-line-to"]);for(var k=M;k>=N;--k){g[R].removeLine(k)}}}else{if(I=="lhs"){if(K.op=="a"){var N=parseInt(K[R+"-line-from"]);var M=parseInt(K[R+"-line-to"]);for(var k=M;k>=N;--k){g[R].removeLine(k)}}else{g[R].replaceRange(P,CodeMirror.Pos(K[R+"-line-from"]+1,0))}}}}g.lhs.setValue(g.lhs.getValue());g.rhs.setValue(g.rhs.getValue());return false});this.trace("change","markup buttons time",r.stop())},_draw_info:function(c,b){var d=jQuery(this.editor[c].getScrollerElement()).height();var e=jQuery(this.editor[c].getScrollerElement()).children(":first-child").height();var g=document.getElementById(c+"-"+b+"-canvas");if(g==undefined){throw"Failed to find: "+c+"-"+b+"-canvas"}var a=jQuery("#"+this.id+"-lhs-margin");var f=jQuery("#"+this.id+"-rhs-margin");return{visible_page_height:d,gutter_height:e,visible_page_ratio:(d/e),margin_ratio:(d/e),lhs_scroller:jQuery(this.editor[c].getScrollerElement()),rhs_scroller:jQuery(this.editor[b].getScrollerElement()),lhs_lines:this.editor[c].lineCount(),rhs_lines:this.editor[b].lineCount(),dcanvas:g,clhs:a,crhs:f,lhs_xyoffset:jQuery(a).offset(),rhs_xyoffset:jQuery(f).offset()}},_draw_diff:function(a,E,D){var A=this._draw_info(a,E);var c=A.clhs.get(0);var n=A.crhs.get(0);var u=A.dcanvas.getContext("2d");var l=c.getContext("2d");var s=n.getContext("2d");this.trace("draw","visible_page_height",A.visible_page_height);this.trace("draw","gutter_height",A.gutter_height);this.trace("draw","visible_page_ratio",A.visible_page_ratio);this.trace("draw","lhs-scroller-top",A.lhs_scroller.scrollTop());this.trace("draw","rhs-scroller-top",A.rhs_scroller.scrollTop());jQuery.each(jQuery.find("#"+this.id+" canvas"),function(){jQuery(this).get(0).height=A.visible_page_height});A.clhs.unbind("click");A.crhs.unbind("click");l.beginPath();l.fillStyle=this.settings.bgcolor;l.strokeStyle="#888";l.fillRect(0,0,6.5,A.visible_page_height);l.strokeRect(0,0,6.5,A.visible_page_height);s.beginPath();s.fillStyle=this.settings.bgcolor;s.strokeStyle="#888";s.fillRect(0,0,6.5,A.visible_page_height);s.strokeRect(0,0,6.5,A.visible_page_height);var z=this._get_viewport(a,E);for(var y=0;y<D.length;++y){var p=D[y];this.trace("draw",p);var e=((p["lhs-y-start"]+A.lhs_scroller.scrollTop())*A.visible_page_ratio);var r=((p["lhs-y-end"]+A.lhs_scroller.scrollTop())*A.visible_page_ratio)+1;var t=((p["rhs-y-start"]+A.rhs_scroller.scrollTop())*A.visible_page_ratio);var C=((p["rhs-y-end"]+A.rhs_scroller.scrollTop())*A.visible_page_ratio)+1;this.trace("draw","marker calculated",e,r,t,C);l.beginPath();l.fillStyle=this.settings.fgcolor[p.op];l.strokeStyle="#000";l.lineWidth=0.5;l.fillRect(1.5,e,4.5,Math.max(r-e,5));l.strokeRect(1.5,e,4.5,Math.max(r-e,5));s.beginPath();s.fillStyle=this.settings.fgcolor[p.op];s.strokeStyle="#000";s.lineWidth=0.5;s.fillRect(1.5,t,4.5,Math.max(C-t,5));s.strokeRect(1.5,t,4.5,Math.max(C-t,5));if(!this._is_change_in_view(z,p)){continue}e=p["lhs-y-start"];r=p["lhs-y-end"];t=p["rhs-y-start"];C=p["rhs-y-end"];var k=3;u.beginPath();u.strokeStyle=this.settings.fgcolor[p.op];u.lineWidth=1;var b=this.draw_lhs_width;var v=r-e-1;var x=this.draw_lhs_min;var w=e;u.moveTo(x,w);if(navigator.appName=="Microsoft Internet Explorer"){u.lineTo(this.draw_lhs_min+this.draw_lhs_width,e);u.lineTo(this.draw_lhs_min+this.draw_lhs_width,r+1);u.lineTo(this.draw_lhs_min,r+1)}else{if(v<=0){u.lineTo(x+b,w)}else{u.arcTo(x+b,w,x+b,w+k,k);u.arcTo(x+b,w+v,x+b-k,w+v,k)}u.lineTo(x,w+v)}u.stroke();b=this.draw_rhs_width;v=C-t-1;x=this.draw_rhs_max;w=t;u.moveTo(x,w);if(navigator.appName=="Microsoft Internet Explorer"){u.lineTo(this.draw_rhs_max-this.draw_rhs_width,t);u.lineTo(this.draw_rhs_max-this.draw_rhs_width,C+1);u.lineTo(this.draw_rhs_max,C+1)}else{if(v<=0){u.lineTo(x-b,w)}else{u.arcTo(x-b,w,x-b,w+k,k);u.arcTo(x-b,w+v,x-k,w+v,k)}u.lineTo(x,w+v)}u.stroke();var g=this.draw_lhs_min+this.draw_lhs_width;var f=e+(r+1-e)/2;var q=this.draw_rhs_max-this.draw_rhs_width;var o=t+(C+1-t)/2;u.moveTo(g,f);if(f==o){u.lineTo(q,o)}else{u.bezierCurveTo(g+12,f-3,q-12,o-3,q,o)}u.stroke()}l.fillStyle=this.settings.vpcolor;s.fillStyle=this.settings.vpcolor;var B=A.clhs.height()*A.visible_page_ratio;var m=(A.lhs_scroller.scrollTop()/A.gutter_height)*A.clhs.height();var j=A.crhs.height()*A.visible_page_ratio;var d=(A.rhs_scroller.scrollTop()/A.gutter_height)*A.crhs.height();this.trace("draw","cls.height",A.clhs.height());this.trace("draw","lhs_scroller.scrollTop()",A.lhs_scroller.scrollTop());this.trace("draw","gutter_height",A.gutter_height);this.trace("draw","visible_page_ratio",A.visible_page_ratio);this.trace("draw","lhs from",m,"lhs to",B);this.trace("draw","rhs from",d,"rhs to",j);l.fillRect(1.5,m,4.5,B);s.fillRect(1.5,d,4.5,j);A.clhs.click(function(F){var G=F.pageY-A.lhs_xyoffset.top-(B/2);var i=Math.max(0,(G/c.height)*A.lhs_scroller.get(0).scrollHeight);A.lhs_scroller.scrollTop(i)});A.crhs.click(function(F){var G=F.pageY-A.rhs_xyoffset.top-(j/2);var i=Math.max(0,(G/n.height)*A.rhs_scroller.get(0).scrollHeight);A.rhs_scroller.scrollTop(i)})},trace:function(a){if(this.settings._debug.indexOf(a)>=0){arguments[0]=a+":";console.log([].slice.apply(arguments))}}});jQuery.pluginMaker=function(a){jQuery.fn[a.prototype.name]=function(c){var b=jQuery.makeArray(arguments),e=b.slice(1);var d=undefined;this.each(function(){var f=jQuery.data(this,a.prototype.name);if(f){if(typeof c=="string"){d=f[c].apply(f,e)}else{if(f.update){return f.update.apply(f,b)}}}else{new a(this,c)}});if(d!=undefined){return d}}};jQuery.pluginMaker(Mgly.mergely);