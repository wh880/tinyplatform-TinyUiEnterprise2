
<script>

    UE.plugins['tinyat'] = function () {
        var me = this,thePlugins = 'tinyat';

        var popup = new baidu.editor.ui.Popup( {
            editor:this,
            content: '',
            className: 'edui-bubble',
            _edittext: function () {
                baidu.editor.plugins[thePlugins].editdom = popup.anchorEl;
                me.execCommand(thePlugins);
                this.hide();
            },
            _delete:function(){
                if( window.confirm('确认删除该控件吗？') ) {
                    baidu.editor.dom.domUtils.remove(this.anchorEl,false);
                }
                this.hide();
            }
        } );
        popup.render();
        me.addListener( 'keyup', function( t, evt ) {
            var range = me.selection.getRange();
            var el = UE.dom.domUtils.findParentByTagName( range.startContainer, 'span', true );
            if(!el){
                el = UE.dom.domUtils.findParentByTagName( range.startContainer, 'p', true );
            }
            if(!el){
                el = UE.dom.domUtils.findParentByTagName( range.startContainer, 'body', true );
            }
            var strText=$(el).text();
            var reg = /@([^@\s]*)$/g;
            var arr = strText.match(reg);
            if(arr){
                var result = arr[0].replace(reg, "$1");
                var html = popup.formatHtml(
                        '<nobr>宏控件: <span onclick=$$._edittext() class="edui-clickable">编辑</span>&nbsp;&nbsp;<span onclick=$$._delete() class="edui-clickable">删除</span></nobr>' );
                if ( html ) {
                    popup.getDom('content').innerHTML = html;
                    popup.anchorEl = el;
                    popup.showAnchor(popup.anchorEl);

                }
            }else{
                popup.hide();
            }

          /*  var s=window.getSelection();
            var rng = document.body.createTextRange();
            console.log(rng.text)
            console.log(evt.which,s,el);*/
            evt = evt || window.event;
            var el = evt.target || evt.srcElement;
            var s= document.getElementsByTagName("body")[0].createTextRange();
           // s.setEndPoint("StartToStart",document.createTextRange())
            alert(s.text);
          /*  var s=window.getSelection();
            var rng = document.body.createTextRange();
            console.log(rng.text)
            console.log(evt.which,s,el);*/
            /*var leipiPlugins = el.getAttribute('tinyplugins');
            if ( /span/ig.test( el.tagName ) && leipiPlugins==thePlugins) {
                var html = popup.formatHtml(
                        '<nobr>宏控件: <span onclick=$$._edittext() class="edui-clickable">编辑</span>&nbsp;&nbsp;<span onclick=$$._delete() class="edui-clickable">删除</span></nobr>' );
                if ( html ) {
                    popup.getDom( 'content' ).innerHTML = html;
                    popup.anchorEl = el;
                    popup.showAnchor( popup.anchorEl );
                } else {
                    popup.hide();
                }
            }*/
        });
    };

</script>

#@ueditor("uncontent" "inputName")测试一下#end