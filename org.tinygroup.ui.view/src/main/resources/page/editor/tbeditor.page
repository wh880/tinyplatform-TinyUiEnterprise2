#macro tTbditor(textareaEditorName tbMap)#set(tid=tbMap?.id?:fmt("tid%d",rand()))
<textarea id="${tid}" name="${textareaEditorName}" #mapToHtml(tbMap)>#bodyContent</textarea>
<script type="text/javascript">
    $(function(){
        function getPasteImage(e) {
            console.log(e.clipboardData);
            return e.clipboardData && e.clipboardData.items && e.clipboardData.items.length == 1 && /^image\//.test(e.clipboardData.items[0].type) ? e.clipboardData.items : null;
        }

        function getDropImage(e) {
            return e.dataTransfer && e.dataTransfer.files ? e.dataTransfer.files : null;
        }
        $.extend(true, $.trumbowyg.upload, { #if(tbMap?.serverPath)
            serverPath: '#link(tbMap?.serverPath)',#end #if(tbMap?.fileFieldName)
            fileFieldName: '${tbMap?.fileFieldName}',#end #if(tbMap?.urlPropertyName)
            urlPropertyName: '${tbMap?.urlPropertyName}'#end
        });
        $('#${tid}').trumbowyg({
            lang:"zh_cn",
            closable: false,
            mobile: true,
            fixedBtnPane: false,
            fixedFullWidth: true,
            btnsDef: {
                align: {
                    dropdown: ['justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull'],
                    ico: 'justifyLeft'
                },
                image: {
                    dropdown: ['insertImage', 'upload'],
                    ico: 'insertImage'
                }
            },
            btns: ['viewHTML','bold','|', 'italic','|', "link" ,'|', 'image','|', 'formatting','|', 'align','|', 'btnGrp-lists','|', 'foreColor', 'backColor'],
            autoAjustHeight: true,
            autogrow:true

        }).on('tbwblur',function(){
            $(this).val($(this).prev(".trumbowyg-editor:first").html());
        });
    })
</script>
#end

#*<script>
(function ($) {
   .on("tbwpaste",function (e,a) {

        var me = this;

        var sendAndInsertImage = function (file, editor) {
            //模拟数据
            var fd = new FormData();
            fd.append(editor.options.imageFieldName || 'upfile', file, file.name || ('blob.' + file.type.substr('image/'.length)));
            fd.append('type', 'ajax');
            var xhr = new XMLHttpRequest();
            xhr.open("post", me.options.imageUrl, true);
            xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
            xhr.addEventListener('load', function (e) {
                try {
                    var json = eval('(' + e.target.response + ')'),
                            link = json.url,
                            picLink = me.options.imagePath + link;
                    tbw.execCmd('insertImage', picLink);
                } catch (er) {
                }
            });
            xhr.send(fd);
        };

        function getPasteImage(e) {
            return e.clipboardData && e.clipboardData.items && e.clipboardData.items.length == 1 && /^image\//.test(e.clipboardData.items[0].type) ? e.clipboardData.items : null;
        }

        function getDropImage(e) {
            return e.dataTransfer && e.dataTransfer.files ? e.dataTransfer.files : null;
        }

        me.addListener('ready', function () {
            if (window.FormData && window.FileReader) {
                var autoUploadHandler = function (e) {
                    var hasImg = false,
                            items;
                    //获取粘贴板文件列表或者拖放文件列表
                    items = e.type == 'paste' ? getPasteImage(e.originalEvent) : getDropImage(e.originalEvent);
                    if (items) {
                        var len = items.length,
                                file;
                        while (len--) {
                            file = items[len];
                            if (file.getAsFile) file = file.getAsFile();
                            if (file && file.size > 0 && /image\/\w+/i.test(file.type)) {
                                sendAndInsertImage(file, me);
                                hasImg = true;
                            }
                        }
                        if (hasImg) return false;
                    }

                };
                me.$body.on('paste drop', autoUploadHandler);

            }
        });

    };
});
</script>*#


#@tTbditor("bodycontent")#end