/*!
 * jQCloud 2.0.1
 * Copyright 2011 Luca Ongaro (http://www.lucaongaro.eu)
 * Copyright 2013 Daniel White (http://www.developerdan.com)
 * Copyright 2014 Damien "Mistic" Sorel (http://www.strangeplanet.fr)
 * Licensed under MIT (http://opensource.org/licenses/MIT)
 */
(function(b){var c=function(f,d,e){this.$element=b(f);this.word_array=d||[];this.options=e;this.sizeGenerator=null;this.colorGenerator=null;this.data={placed_words:[],timeouts:{},namespace:null,step:null,angle:null,aspect_ratio:null,max_weight:null,min_weight:null,sizes:[],colors:[]};this.initialize()};c.DEFAULTS={width:100,height:100,center:{x:0.5,y:0.5},steps:10,delay:null,shape:"elliptic",classPattern:"w{n}",encodeURI:true,removeOverflowing:true,afterCloudRender:null,autoResize:false,colors:null,fontSize:null,template:null};c.prototype={initialize:function(){if(this.options.width){this.$element.width(this.options.width)}else{this.options.width=this.$element.width()}if(this.options.height){this.$element.height(this.options.height)}else{this.options.height=this.$element.height()}this.options=b.extend(true,{},c.DEFAULTS,this.options);if(this.options.delay===null){this.options.delay=this.word_array.length>50?10:0}if(this.options.center.x>1){this.options.center.x=this.options.center.x/this.options.width;this.options.center.y=this.options.center.y/this.options.height}if(typeof this.options.colors=="function"){this.colorGenerator=this.options.colors}else{if(b.isArray(this.options.colors)){var e=this.options.colors.length;if(e>0){if(e<this.options.steps){for(var g=e;g<this.options.steps;g++){this.options.colors[g]=this.options.colors[e-1]}}this.colorGenerator=function(h){return this.options.colors[this.options.steps-h]}}}}if(typeof this.options.fontSize=="function"){this.sizeGenerator=this.options.fontSize}else{if(b.isPlainObject(this.options.fontSize)){this.sizeGenerator=function(k,i,l){var h=k*this.options.fontSize.from,j=k*this.options.fontSize.to;return Math.round(j+(h-j)*1/(this.options.steps-1)*(l-1))+"px"}}else{if(b.isArray(this.options.fontSize)){var d=this.options.fontSize.length;if(d>0){if(d<this.options.steps){for(var f=d;f<this.options.steps;f++){this.options.fontSize[f]=this.options.fontSize[d-1]}}this.sizeGenerator=function(i,h,j){return this.options.fontSize[this.options.steps-j]}}}}}this.data.angle=Math.random()*6.28;this.data.step=(this.options.shape==="rectangular")?18:2;this.data.aspect_ratio=this.options.width/this.options.height;this.clearTimeouts();this.data.namespace=(this.$element.attr("id")||Math.floor((Math.random()*1000000)).toString(36))+"_word_";this.$element.addClass("jqcloud");if(this.$element.css("position")==="static"){this.$element.css("position","relative")}this.createTimeout(b.proxy(this.drawWordCloud,this),10);if(this.options.autoResize){b(window).on("resize",a(function(){var h={width:this.$element.width(),height:this.$element.height()};if(h.width!=this.options.width||h.height!=this.options.height){this.options.width=h.width;this.options.height=h.height;this.data.aspect_ratio=this.options.width/this.options.height;this.update(this.word_array)}},50,this))}},createTimeout:function(f,e){var d=setTimeout(b.proxy(function(){delete this.data.timeouts[d];f()},this),e);this.data.timeouts[d]=true},clearTimeouts:function(){b.each(this.data.timeouts,function(d){clearTimeout(d)});this.data.timeouts={}},overlapping:function(e,d){if(Math.abs(2*e.left+e.width-2*d.left-d.width)<e.width+d.width){if(Math.abs(2*e.top+e.height-2*d.top-d.height)<e.height+d.height){return true}}return false},hitTest:function(f){for(var e=0,d=this.data.placed_words.length;e<d;e++){if(this.overlapping(f,this.data.placed_words[e])){return true}}return false},drawWordCloud:function(){var e,d;this.$element.children('[id^="'+this.data.namespace+'"]').remove();if(this.word_array.length===0){return}for(e=0,d=this.word_array.length;e<d;e++){this.word_array[e].weight=parseFloat(this.word_array[e].weight,10)}this.word_array.sort(function(g,f){return f.weight-g.weight});this.data.max_weight=this.word_array[0].weight;this.data.min_weight=this.word_array[this.word_array.length-1].weight;this.data.colors=[];if(this.colorGenerator){for(e=0;e<this.options.steps;e++){this.data.colors.push(this.colorGenerator(e+1))}}this.data.sizes=[];if(this.sizeGenerator){for(e=0;e<this.options.steps;e++){this.data.sizes.push(this.sizeGenerator(this.options.width,this.options.height,e+1))}}if(this.options.delay>0){this.drawOneWordDelayed()}else{for(e=0,d=this.word_array.length;e<d;e++){this.drawOneWord(e,this.word_array[e])}if(typeof this.options.afterCloudRender==="function"){this.options.afterCloudRender.call(this.$element)}}},drawOneWord:function(h,d){var f=this.data.namespace+h,j="#"+f,e=this.data.angle,i=0,o=0,n=0,g=Math.floor(this.options.steps/2),k,m,l;d.attr=b.extend({},d.html,{id:f});if(this.data.max_weight!=this.data.min_weight){g=Math.round((d.weight-this.data.min_weight)*1*(this.options.steps-1)/(this.data.max_weight-this.data.min_weight))+1}k=b("<span>").attr(d.attr);if(this.options.classPattern){k.addClass(this.options.classPattern.replace("{n}",g))}if(this.data.colors.length){k.css("color",this.data.colors[g-1])}if(this.data.sizes.length){k.css("font-size",this.data.sizes[g-1])}if(this.options.template){k.html(this.options.template(d))}else{if(d.link){if(typeof d.link==="string"){d.link={href:d.link}}if(this.options.encodeURI){d.link.href=encodeURI(d.link.href).replace(/'/g,"%27")}k.append(b("<a>").attr(d.link).text(d.text))}else{k.text(d.text)}}if(d.handlers){k.on(d.handlers)}this.$element.append(k);m={width:k.width(),height:k.height()};m.left=this.options.center.x*this.options.width-m.width/2;m.top=this.options.center.y*this.options.height-m.height/2;l=k[0].style;l.position="absolute";l.left=m.left+"px";l.top=m.top+"px";while(this.hitTest(m)){if(this.options.shape==="rectangular"){o++;if(o*this.data.step>(1+Math.floor(n/2))*this.data.step*((n%4%2)===0?1:this.data.aspect_ratio)){o=0;n++}switch(n%4){case 1:m.left+=this.data.step*this.data.aspect_ratio+Math.random()*2;break;case 2:m.top-=this.data.step+Math.random()*2;break;case 3:m.left-=this.data.step*this.data.aspect_ratio+Math.random()*2;break;case 0:m.top+=this.data.step+Math.random()*2;break}}else{i+=this.data.step;e+=(h%2===0?1:-1)*this.data.step;m.left=this.options.center.x*this.options.width-(m.width/2)+(i*Math.cos(e))*this.data.aspect_ratio;m.top=this.options.center.y*this.options.height+i*Math.sin(e)-(m.height/2)}l.left=m.left+"px";l.top=m.top+"px"}if(this.options.removeOverflowing&&(m.left<0||m.top<0||(m.left+m.width)>this.options.width||(m.top+m.height)>this.options.height)){k.remove();return}this.data.placed_words.push(m);if(typeof d.afterWordRender==="function"){d.afterWordRender.call(k)}},drawOneWordDelayed:function(d){d=d||0;if(!this.$element.is(":visible")){this.createTimeout(b.proxy(function(){this.drawOneWordDelayed(d)},this),10);return}if(d<this.word_array.length){this.drawOneWord(d,this.word_array[d]);this.createTimeout(b.proxy(function(){this.drawOneWordDelayed(d+1)},this),this.options.delay)}else{if(typeof this.options.afterCloudRender=="function"){this.options.afterCloudRender.call(this.$element)}}},destroy:function(){this.clearTimeouts();this.$element.removeClass("jqcloud");this.$element.removeData("jqcloud");this.$element.children('[id^="'+this.namespace+'"]').remove()},update:function(d){this.word_array=d;this.data.placed_words=[];this.clearTimeouts();this.drawWordCloud()}};function a(g,d,e){var f={pid:null,last:0};return function(){var i=new Date().getTime()-f.last,j=arguments,k=this;function h(){f.last=new Date().getTime();return g.apply(e||k,Array.prototype.slice.call(j))}if(i>d){return h()}else{clearTimeout(f.pid);f.pid=setTimeout(h,d-i)}}}b.fn.jQCloud=function(d,f){var e=arguments;return this.each(function(){var i=b(this),h=i.data("jqcloud");if(!h&&d==="destroy"){return}if(!h){var g=typeof f==="object"?f:{};i.data("jqcloud",(h=new c(this,d,g)))}else{if(typeof d==="string"){h[d].apply(h,Array.prototype.slice.call(e,1))}}})};b.fn.jQCloud.defaults={set:function(d){b.extend(true,c.DEFAULTS,d)},get:function(e){var d=c.DEFAULTS;if(e){d=d[e]}return b.extend(true,{},d)}}})(jQuery);